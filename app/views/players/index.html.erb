<% content_for :meta_title, "Fantasy Forecast - Weather-Tiered FPL Player Rankings" %>
<% content_for :meta_description, "Weather-tiered FPL player rankings for Gameweek #{@gameweek}. Our algorithm analyzes form, fixtures, and expected goals to rank every Premier League player from sunshine to snow." %>
<% content_for :meta_url, root_url %>

<%= turbo_frame_tag "rankings_container" do %>
    <div class="mb-6">
      <h1 class="text-xl sm:text-2xl font-semibold text-zinc-900"><%= @page_title %></h1>
      <p class="mt-1 text-sm text-zinc-500">Form, fixtures, and expected goals analyzed into weather tiers.</p>
    </div>

    <%= form_with url: root_path, method: :get, data: { turbo_frame: "rankings_container", turbo_action: "advance" }, id: "filters-form" do |f| %>
      <div class="flex flex-wrap items-center gap-4 mb-6">
        <!-- Gameweek Selector -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-zinc-500">Gameweek</span>
          <%= render DropdownComponent.new(
            label: "Gameweek",
            name: "gameweek",
            options: @available_gameweeks.map { |w| [w, w] },
            selected: @gameweek
          ) %>
        </div>

        <!-- Team Selector -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-zinc-500">Team</span>
          <%= render DropdownComponent.new(
            label: "Team",
            name: "team_id",
            options: [['All', '']] + @available_teams.map { |t| [t.name, t.id] },
            selected: @team_filter
          ) %>
        </div>

        <!-- Position Filter -->
        <div class="flex items-center gap-1" role="radiogroup">
          <% @available_positions.each do |position| %>
            <% position_config = FantasyForecast::POSITION_CONFIG[position] %>
            <% is_active = @position_filter == position %>
            <label class="px-3 py-1.5 text-sm font-medium rounded-lg cursor-pointer transition-colors <%= is_active ? 'bg-zinc-900 text-white' : 'text-zinc-500 hover:text-zinc-900' %>">
              <%= radio_button_tag :position, position, is_active,
                  class: "sr-only",
                  onchange: "this.form.requestSubmit()" %><%= position_config[:display_name] %>
            </label>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Rankings Table -->
    <% if @consensus_rankings.any? %>
      <div class="overflow-hidden rounded-lg border border-zinc-200 bg-white">
        <table class="min-w-full text-left text-sm/6 text-zinc-950">
          <thead class="text-zinc-500">
            <tr>
              <th class="border-b border-zinc-200 px-2 sm:px-4 py-2 font-medium first:pl-3 first:sm:pl-6 last:pr-3 last:sm:pr-6 w-px whitespace-nowrap">Rank</th>
              <th class="border-b border-zinc-200 px-2 sm:px-4 py-2 font-medium first:pl-3 first:sm:pl-6 last:pr-3 last:sm:pr-6">Player</th>
              <th class="border-b border-zinc-200 px-2 sm:px-4 py-2 font-medium first:pl-3 first:sm:pl-6 last:pr-3 last:sm:pr-6 hidden lg:table-cell">Form</th>
              <th class="border-b border-zinc-200 px-2 sm:px-4 py-2 font-medium first:pl-3 first:sm:pl-6 last:pr-3 last:sm:pr-6 text-right hidden sm:table-cell">Fixture</th>
            </tr>
          </thead>
          <tbody>
            <% @consensus_rankings.each do |ranking| %>
              <% player = @players_by_id[ranking.player_id] %>
              <% tier = ranking.tier %>
              <% tier_data = tier_info(tier) %>
              <tr class="cursor-pointer hover:bg-zinc-50"
                  onclick="Turbo.visit('<%= player_path(player) %>')"
                  role="link"
                  tabindex="0"
                  onkeydown="if(event.key === 'Enter') Turbo.visit('<%= player_path(player) %>')">
                <td class="border-b border-zinc-100 px-2 sm:px-4 py-4 first:pl-3 first:sm:pl-6 last:pr-3 last:sm:pr-6 w-px whitespace-nowrap">
                  <span class="inline-flex items-center gap-2">
                    <span class="text-xl"><%= tier_data[:symbol] %></span>
                    <span class="text-zinc-500"><%= ranking.bot_rank || '-' %></span>
                  </span>
                </td>
                <td class="border-b border-zinc-100 px-2 sm:px-4 py-4 first:pl-3 first:sm:pl-6 last:pr-3 last:sm:pr-6">
                  <div class="flex items-center gap-3 sm:gap-4">
                    <%= render PlayerAvatarComponent.new(player: player, size: :medium) %>
                    <div>
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-lg"><%= player.short_name %></span>
                        <% news_count = cached_news_count(player) %>
                        <% if news_count && news_count > 0 %>
                          <span class="inline-flex items-center gap-1 px-1.5 py-0.5 text-xs font-medium bg-zinc-100 text-zinc-600 rounded-full" title="<%= news_count %> recent news <%= news_count == 1 ? 'article' : 'articles' %>">
                            <svg class="size-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                            </svg>
                            <%= news_count %>
                          </span>
                        <% end %>
                      </div>
                      <div class="text-zinc-500 flex items-center gap-1">
                          <% if player.team&.badge_url %>
                            <%= image_tag player.team.badge_url, alt: "", class: "size-5" %>
                          <% end %>
                          <%= player.team&.name %>
                        </div>
                    </div>
                  </div>
                </td>
                <td class="border-b border-zinc-100 px-2 sm:px-4 py-4 first:pl-3 first:sm:pl-6 last:pr-3 last:sm:pr-6 hidden lg:table-cell">
                  <%= render FormComponent.new(scores: @performances_by_player[player.id]) %>
                </td>
                <td class="border-b border-zinc-100 px-2 sm:px-4 py-4 first:pl-3 first:sm:pl-6 last:pr-3 last:sm:pr-6 text-zinc-500 text-right hidden sm:table-cell">
                  <div class="flex flex-col items-end gap-1">
                    <% (@matches_by_team[player.team_id] || []).each do |match| %>
                      <%= render FixtureComponent.new(match: match, player: player) %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="px-6 py-8 text-center">
        <div class="text-zinc-500">
          <svg class="mx-auto h-12 w-12 text-zinc-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M34 40h10v-4a6 6 0 00-10.712-3.714M34 40H14m20 0v-4a9.971 9.971 0 00-.712-3.714M14 40H4v-4a6 6 0 0110.713-3.714M14 40v-4c0-1.313.253-2.566.713-3.714m0 0A9.971 9.971 0 0124 24c4.004 0 7.625 2.31 9.287 5.286" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <h3 class="mt-2 text-sm font-medium text-zinc-900">No rankings yet</h3>
          <p class="mt-1 text-sm text-zinc-500">
            No ranking data available for gameweek <%= @gameweek %><%= " (#{@position_filter.capitalize}s)" if @position_filter.present? %>.
          </p>
        </div>
      </div>
    <% end %>

<% end %>

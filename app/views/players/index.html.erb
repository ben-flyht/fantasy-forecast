<% content_for :meta_title, "Fantasy Forecast - Weather-Tiered FPL Player Rankings" %>
<% content_for :meta_description, "Weather-tiered FPL player rankings for Gameweek #{@gameweek}. Our algorithm analyzes form, fixtures, and expected goals to rank every Premier League player from sunshine to snow." %>
<% content_for :meta_url, root_url %>

<div class="container mx-auto px-2 md:px-4 py-4 md:py-8">
  <%= turbo_frame_tag "rankings_container" do %>
    <div class="mb-4 md:mb-8">
      <h1 class="text-xl md:text-3xl font-bold text-gray-800 mb-1 md:mb-2"><%= @page_title %></h1>
      <p class="text-sm md:text-base text-gray-500">Our algorithm analyzes form, fixtures, and expected goals to rank every Premier League player into weather tiers - from must-start sunshine picks to avoid-at-all-costs snow.</p>
    </div>

    <%= form_with url: root_path, method: :get, data: { turbo_frame: "rankings_container", turbo_action: "advance" }, id: "filters-form" do |f| %>
      <!-- Gameweek and Team Filters (not sticky) -->
      <div class="pt-4 mb-3 md:mb-4">
        <div class="flex flex-wrap gap-3 md:gap-4">
          <!-- Gameweek Selector -->
          <div class="flex items-center space-x-2">
            <label for="gameweek-select" class="text-xs md:text-sm font-medium text-gray-700 whitespace-nowrap">Gameweek:</label>
            <%= select_tag :gameweek,
                options_for_select(@available_gameweeks.map { |w| [w, w] }, @gameweek),
                {
                  id: "gameweek-select",
                  class: "border border-gray-300 rounded-md px-2 md:px-3 py-1.5 md:py-2 text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-amber-400",
                  onchange: "this.form.requestSubmit()"
                } %>
          </div>

          <!-- Team Selector -->
          <div class="flex items-center space-x-2">
            <label for="team-select" class="text-xs md:text-sm font-medium text-gray-700 whitespace-nowrap">Team:</label>
            <%= select_tag :team_id,
                options_for_select([['All Teams', '']] + @available_teams.map { |t| [t.name, t.id] }, @team_filter),
                {
                  id: "team-select",
                  class: "border border-gray-300 rounded-md px-2 md:px-3 py-1.5 md:py-2 text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-amber-400",
                  onchange: "this.form.requestSubmit()"
                } %>
          </div>
        </div>
      </div>

      <!-- Position Filter (sticky with JS) -->
      <div data-controller="sticky-shadow">
        <div data-sticky-shadow-target="sentinel"></div>
        <div data-sticky-shadow-target="placeholder" style="height: 0;"></div>
        <div class="z-40 bg-white transition-shadow duration-200 -mx-2 md:-mx-4 mb-4 md:mb-6" data-sticky-shadow-target="container">
          <div class="container mx-auto px-2 md:px-4">
            <div class="flex flex-wrap items-center gap-2 py-3">
              <span class="text-xs md:text-sm font-medium text-gray-700">Position:</span>
              <div class="flex flex-wrap gap-2" role="radiogroup">
                <% @available_positions.each do |position| %>
                  <% position_config = FantasyForecast::POSITION_CONFIG[position] %>
                  <% is_active = @position_filter == position %>
                  <%
                    if is_active
                      pill_classes = 'bg-amber-200 text-gray-800 border-amber-200 shadow-md'
                    else
                      pill_classes = 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                    end
                  %>
                  <label class="px-2 md:px-3 py-1.5 md:py-2 text-xs font-medium rounded-md border transition-all cursor-pointer inline-block <%= pill_classes %>">
                    <%= radio_button_tag :position, position, is_active,
                        style: "position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;",
                        onchange: "this.form.requestSubmit()" %><%= position_config[:display_name] %>
                  </label>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Tiered Rankings Table -->
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">

    <% if @consensus_rankings.any? %>
      <table class="w-full">
        <% (1..5).each do |tier_num| %>
          <% tier_players = @tier_groups[tier_num] %>
          <% next if tier_players.blank? %>

          <%= render TierHeaderComponent.new(tier: tier_num) %>

          <tbody>
            <% tier_players.each_with_index do |ranking, idx| %>
              <% player = @players_by_id[ranking.player_id] %>
              <% border_class = idx > 0 ? "border-t border-white" : "" %>
              <tr class="<%= tier_row_class(tier_num) %> <%= border_class %> cursor-pointer hover:brightness-95 transition-all"
                  onclick="Turbo.visit('<%= player_path(player) %>')"
                  role="link"
                  tabindex="0"
                  onkeydown="if(event.key === 'Enter') Turbo.visit('<%= player_path(player) %>')">
                <td class="px-1 md:px-4 py-2 md:py-4 whitespace-nowrap text-sm md:text-lg font-medium text-gray-800 w-10 md:w-16 text-center align-top">
                  <%= ranking.bot_rank || '-' %>
                </td>
                <td class="px-2 md:px-6 py-2 md:py-4 align-top" colspan="2">
                  <div class="flex items-start justify-between gap-2">
                    <div class="flex-1">
                      <%= render PlayerCardComponent.new(player: player) %>
                      <% if ranking.explanation.present? %>
                        <p class="text-xs md:text-sm text-gray-500 italic mt-2"><%= ranking.explanation %></p>
                      <% end %>
                    </div>
                    <div class="flex flex-col items-end gap-1 flex-shrink-0">
                      <div class="whitespace-nowrap text-right text-xs md:text-sm">
                        <%= render OpponentComponent.new(player: player, gameweek: @gameweek, matches_by_team: @matches_by_team) %>
                      </div>
                      <% news_count = cached_news_count(player) %>
                      <% if news_count && news_count > 0 %>
                        <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">
                          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 002 2H4a2 2 0 01-2-2V5zm3 1h6v4H5V6zm6 6H5v2h6v-2z" clip-rule="evenodd"/>
                            <path d="M15 7h1a2 2 0 012 2v5.5a1.5 1.5 0 01-3 0V7z"/>
                          </svg>
                          <%= news_count %>
                        </span>
                      <% end %>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        <% end %>
      </table>
    <% else %>
      <div class="px-6 py-8 text-center">
        <div class="text-gray-500">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M34 40h10v-4a6 6 0 00-10.712-3.714M34 40H14m20 0v-4a9.971 9.971 0 00-.712-3.714M14 40H4v-4a6 6 0 0110.713-3.714M14 40v-4c0-1.313.253-2.566.713-3.714m0 0A9.971 9.971 0 0124 24c4.004 0 7.625 2.31 9.287 5.286" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <h3 class="mt-2 text-sm font-medium text-gray-800">No rankings yet</h3>
          <p class="mt-1 text-sm text-gray-500">
            No ranking data available for gameweek <%= @gameweek %><%= " (#{@position_filter.capitalize}s)" if @position_filter.present? %>.
          </p>
        </div>
      </div>
    <% end %>
    </div>

  <% end %>

</div>

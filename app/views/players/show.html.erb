<% content_for :meta_title, "#{@player.full_name} - Fantasy Forecast" %>
<% content_for :meta_description, "#{@player.full_name} fantasy football stats, rankings, and news. Get the latest forecast and performance data for your FPL decisions." %>

<div class="container mx-auto px-2 md:px-4 py-4 md:py-8">
  <!-- Back Link -->
  <div class="mb-4">
    <%= link_to root_path(position: @player.position), class: "text-sm text-gray-500 hover:text-amber-600 flex items-center gap-1" do %>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      Back to Rankings
    <% end %>
  </div>

  <!-- Player Header -->
  <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
    <div class="p-4 md:p-6">
      <div class="flex items-start gap-4 md:gap-6">
        <% if @player.photo_url %>
          <%= image_tag @player.photo_url(size: "110x140"), alt: @player.name, class: "w-20 h-24 md:w-28 md:h-36 rounded-lg object-cover shadow" %>
        <% else %>
          <div class="w-20 h-24 md:w-28 md:h-36 rounded-lg bg-gray-200 flex items-center justify-center">
            <svg class="w-12 h-12 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
            </svg>
          </div>
        <% end %>

        <div class="flex-1">
          <h1 class="text-2xl md:text-3xl font-bold text-gray-800"><%= @player.full_name %></h1>
          <div class="flex flex-wrap items-center gap-2 mt-2">
            <% if @player.team %>
              <span class="text-sm px-3 py-1 rounded-full bg-gray-100 text-gray-700"><%= @player.team.name %></span>
            <% end %>
            <span class="text-sm px-3 py-1 rounded-full bg-amber-100 text-amber-800 capitalize"><%= @player.position %></span>
          </div>

          <!-- Injury/Availability Status -->
          <% if @player.news.present? %>
            <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
              <div class="flex items-start gap-2">
                <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <p class="text-sm text-red-700"><%= @player.news %></p>
              </div>
            </div>
          <% end %>

          <!-- Total Points -->
          <div class="mt-3">
            <span class="text-sm text-gray-500">Total Points:</span>
            <span class="text-lg font-bold text-gray-800 ml-1"><%= @total_score %></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Left Column -->
    <div class="space-y-6">
      <!-- Forecast Card -->
      <% if @forecast %>
        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
          <div class="px-4 md:px-6 py-3 bg-gray-50 border-b">
            <h2 class="text-lg font-semibold text-gray-800">Gameweek <%= @forecast[:gameweek] %> Forecast</h2>
          </div>
          <div class="p-4 md:p-6">
            <div class="flex items-center gap-4 mb-4">
              <% if @forecast[:tier] %>
                <div class="text-center">
                  <span class="text-4xl"><%= @forecast[:tier][:symbol] %></span>
                  <p class="text-sm font-medium text-gray-600 mt-1"><%= @forecast[:tier][:name] %></p>
                </div>
              <% end %>
              <div class="flex-1">
                <% if @forecast[:rank] %>
                  <p class="text-sm text-gray-500">Rank among <%= @player.position.pluralize %></p>
                  <p class="text-3xl font-bold text-gray-800">#<%= @forecast[:rank] %></p>
                <% else %>
                  <p class="text-sm text-gray-500">Unranked</p>
                <% end %>
              </div>
            </div>
            <% if @forecast[:explanation].present? %>
              <div class="pt-4 border-t">
                <p class="text-sm text-gray-600 italic"><%= @forecast[:explanation] %></p>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Upcoming Fixture -->
      <% if @upcoming_match %>
        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
          <div class="px-4 md:px-6 py-3 bg-gray-50 border-b">
            <h2 class="text-lg font-semibold text-gray-800">Next Fixture</h2>
          </div>
          <div class="p-4 md:p-6">
            <div class="flex items-center justify-center gap-4">
              <div class="text-center flex-1">
                <p class="font-semibold text-gray-800 <%= @upcoming_match.home_team_id == @player.team_id ? 'text-amber-600' : '' %>">
                  <%= @upcoming_match.home_team.short_name %>
                </p>
                <% if @upcoming_match.home_team_expected_goals %>
                  <p class="text-xs text-gray-500">xG: <%= number_with_precision(@upcoming_match.home_team_expected_goals, precision: 2) %></p>
                <% end %>
              </div>
              <div class="text-center px-4">
                <span class="text-gray-400 font-medium">vs</span>
                <p class="text-xs text-gray-400 mt-1"><%= @upcoming_match.home_team_id == @player.team_id ? '(H)' : '(A)' %></p>
              </div>
              <div class="text-center flex-1">
                <p class="font-semibold text-gray-800 <%= @upcoming_match.away_team_id == @player.team_id ? 'text-amber-600' : '' %>">
                  <%= @upcoming_match.away_team.short_name %>
                </p>
                <% if @upcoming_match.away_team_expected_goals %>
                  <p class="text-xs text-gray-500">xG: <%= number_with_precision(@upcoming_match.away_team_expected_goals, precision: 2) %></p>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Recent Performances -->
      <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="px-4 md:px-6 py-3 bg-gray-50 border-b">
          <h2 class="text-lg font-semibold text-gray-800">Recent Performances</h2>
        </div>
        <% if @performances.any? %>
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">GW</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Points</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              <% @performances.each do |perf| %>
                <tr>
                  <td class="px-4 py-3 text-sm text-gray-800">Gameweek <%= perf.gameweek.fpl_id %></td>
                  <td class="px-4 py-3 text-sm text-right font-semibold <%= perf.gameweek_score.to_i >= 10 ? 'text-green-600' : perf.gameweek_score.to_i <= 2 ? 'text-red-500' : 'text-gray-800' %>">
                    <%= perf.gameweek_score %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <div class="p-4 text-center text-gray-500 text-sm">
            No performance data available yet.
          </div>
        <% end %>
      </div>
    </div>

    <!-- Right Column - News -->
    <div>
      <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="px-4 md:px-6 py-3 bg-gray-50 border-b">
          <h2 class="text-lg font-semibold text-gray-800">Latest News</h2>
        </div>
        <% if @news.any? %>
          <div class="divide-y divide-gray-100">
            <% @news.each do |article| %>
              <a href="<%= article[:url] %>" target="_blank" rel="noopener noreferrer" class="block p-4 hover:bg-gray-50 transition-colors">
                <div class="flex gap-4">
                  <% if article[:image].present? %>
                    <img src="<%= article[:image] %>" alt="" class="w-20 h-20 object-cover rounded flex-shrink-0" onerror="this.style.display='none'">
                  <% end %>
                  <div class="flex-1 min-w-0">
                    <h3 class="text-sm font-medium text-gray-800 line-clamp-2"><%= article[:title] %></h3>
                    <p class="text-xs text-gray-500 mt-1 line-clamp-2"><%= article[:snippet] %></p>
                    <p class="text-xs text-amber-600 mt-2"><%= article[:source] %></p>
                  </div>
                </div>
              </a>
            <% end %>
          </div>
        <% else %>
          <div class="p-6 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
            </svg>
            <p class="mt-2 text-sm text-gray-500">No recent news found for this player.</p>
            <p class="text-xs text-gray-400 mt-1">News is fetched from sports sites when available.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

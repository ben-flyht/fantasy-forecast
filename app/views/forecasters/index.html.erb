<% content_for :title, @page_title %>

<div class="container mx-auto px-2 md:px-4 py-4 md:py-8">
  <%= turbo_frame_tag "rankings_container" do %>
    <div class="mb-4 md:mb-8">
      <h1 class="text-xl md:text-3xl font-bold text-gray-800 mb-3 md:mb-4"><%= @page_title %></h1>

      <!-- Gameweek Filter -->
      <%= form_with url: forecasters_path, method: :get, data: { turbo_frame: "rankings_container", turbo_action: "advance" }, id: "filters-form" do |f| %>
        <div class="flex items-center space-x-2 mb-4 md:mb-6">
          <label for="gameweek-select" class="text-xs md:text-sm font-medium text-gray-700 whitespace-nowrap">Gameweek:</label>
          <%= select_tag :gameweek,
              options_for_select([['All Gameweeks', '']] + @available_gameweeks.map { |w| ["Gameweek #{w}", w] }, @gameweek),
              {
                id: "gameweek-select",
                class: "border border-gray-300 rounded-md px-2 md:px-3 py-1.5 md:py-2 text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",
                onchange: "this.form.requestSubmit()"
              } %>
        </div>
      <% end %>
    </div>

  <!-- Forecaster Rankings Table -->
  <div class="bg-white shadow-lg rounded-lg overflow-hidden">

    <% if @rankings.any? %>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-2 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Rank
            </th>
            <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Forecaster
            </th>
            <th class="hidden md:table-cell px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
              Accuracy
            </th>
            <th class="hidden md:table-cell px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
              Differential
            </th>
            <th class="hidden md:table-cell px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
              Availability
            </th>
            <th class="px-3 md:px-6 py-2 md:py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
              Total Score
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @rankings.each_with_index do |ranking, index| %>
            <% is_current_user = user_signed_in? && current_user.id == ranking[:user_id] %>
            <tr class="<%= is_current_user ? 'bg-yellow-100 border-l-4 border-yellow-400' : '' %>">
              <td class="px-2 md:px-6 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm font-medium text-gray-900">
                <%= index + 1 %>
              </td>
              <td class="px-3 md:px-6 py-2 md:py-4">
                <span class="text-xs md:text-sm font-medium text-gray-900 break-words"><%= ranking[:username] %></span>
              </td>
              <td class="hidden md:table-cell px-6 py-4 whitespace-nowrap text-center text-sm font-medium text-gray-900">
                <%= (ranking[:accuracy_score] * 100).round(2) %>%
              </td>
              <td class="hidden md:table-cell px-6 py-4 whitespace-nowrap text-center text-sm font-medium text-gray-900">
                <%= (ranking[:differential_score] * 100).round(2) %>%
              </td>
              <td class="hidden md:table-cell px-6 py-4 whitespace-nowrap text-center text-sm font-medium text-gray-900">
                <%= (ranking[:availability_score] * 100).round(2) %>%
              </td>
              <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-center text-xs md:text-sm font-medium text-gray-900">
                <%= (ranking[:total_score] * 100).round(2) %>%
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="px-6 py-8 text-center">
        <div class="text-gray-500">
          <h3 class="mt-2 text-sm font-medium text-gray-900">No rankings yet</h3>
          <p class="mt-1 text-sm text-gray-500">
            Rankings will appear once forecasts have been scored.
          </p>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

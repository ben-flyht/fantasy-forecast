<% content_for :title, @page_title %>

<div class="container mx-auto px-2 md:px-4 py-4 md:py-8">
  <!-- Header -->
  <div class="mb-4 md:mb-6">
    <div class="flex items-center justify-between mb-3 md:mb-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800"><%= @user.display_name %></h1>
      </div>
      <%= link_to forecasters_path, class: "inline-flex items-center px-3 md:px-4 py-2 border border-gray-800 text-xs md:text-sm font-medium rounded-md text-gray-800 bg-white hover:bg-gray-50" do %>
        View all forecasters
      <% end %>
    </div>

    <!-- Overall Summary -->
    <%= render 'summary',
               forecast_count: @total_forecast_count,
               avg_total_score: @overall_total_score,
               avg_accuracy_score: @overall_accuracy_score,
               gameweek_rank: @overall_rank,
               gameweek_total_forecasters: @total_forecasters %>
  </div>

  <!-- Weekly Performance Table -->
  <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
    <% if @weekly_rankings.any? %>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-2 md:px-4 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">
              Rank
            </th>
            <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Gameweek
            </th>
            <th class="px-3 md:px-6 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
              Forecasts
            </th>
            <th class="px-3 md:px-6 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
              Accuracy
            </th>
            <th class="px-3 md:px-6 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
              Score
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @weekly_rankings.each do |ranking| %>
            <% is_next_gameweek = @next_gameweek_id && ranking[:gameweek] == @next_gameweek_id %>
            <% has_no_selections = ranking[:forecast_count] == 0 %>
            <tr class="<%= 'bg-gray-50' if has_no_selections %> <%= 'hover:bg-gray-50 cursor-pointer' unless has_no_selections %>" <%= "onclick=\"window.location='#{gameweeks_forecaster_path(@user.id, ranking[:gameweek])}'\"" unless has_no_selections %>>
              <td class="px-2 md:px-4 py-2 md:py-4 whitespace-nowrap text-xs md:text-sm font-medium <%= has_no_selections ? 'text-gray-400' : 'text-gray-800' %> w-16">
                <% if ranking[:rank] %>
                  <%= ranking[:rank] %>
                <% end %>
              </td>
              <td class="px-3 md:px-6 py-2 md:py-4">
                <% if has_no_selections %>
                  <span class="text-xs md:text-sm font-medium text-gray-400">Gameweek <%= ranking[:gameweek] %></span>
                <% else %>
                  <%= link_to gameweeks_forecaster_path(@user.id, ranking[:gameweek]), class: "text-xs md:text-sm font-medium text-gray-800 hover:text-yellow-500 underline" do %>
                    Gameweek <%= ranking[:gameweek] %>
                  <% end %>
                <% end %>
              </td>
              <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-right text-xs md:text-sm <%= has_no_selections ? 'text-gray-400' : 'text-gray-600' %> w-24">
                <%= ranking[:forecast_count] %>
              </td>
              <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-right text-xs md:text-sm <%= has_no_selections ? 'text-gray-400' : 'text-gray-600' %> w-24">
                <% unless is_next_gameweek %>
                  <%= (ranking[:accuracy_score] * 100).round(1) %>%
                <% end %>
              </td>
              <td class="px-3 md:px-6 py-2 md:py-4 whitespace-nowrap text-right text-xs md:text-sm font-medium <%= has_no_selections ? 'text-gray-400' : 'text-gray-800' %> w-24">
                <% unless is_next_gameweek %>
                  <%= ranking[:total_score].round(2) %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="px-6 py-8 text-center">
        <div class="text-gray-500">
          <h3 class="mt-2 text-sm font-medium text-gray-800">No forecasts yet</h3>
          <p class="mt-1 text-sm text-gray-500">
            This forecaster hasn't made any forecasts that have been scored.
          </p>
        </div>
      </div>
    <% end %>
  </div>
</div>

<% content_for :title, @page_title %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900"><%= @user.username %></h1>
        <p class="text-lg text-gray-600 mt-2">Forecaster Performance Profile</p>
      </div>
      <%= link_to users_path,
          class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
        ‚Üê Back to Rankings
      <% end %>
    </div>
  </div>

  <!-- Overall Stats -->
  <% if @overall_stats %>
    <div class="bg-white shadow-sm rounded-lg p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Overall Performance</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="text-center">
          <div class="text-2xl font-bold text-blue-600">#<%= @overall_stats[:rank] %></div>
          <div class="text-sm text-gray-600">Overall Rank</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-green-600"><%= @overall_stats[:weighted_score] %></div>
          <div class="text-sm text-gray-600">Weighted Score</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-purple-600"><%= @overall_stats[:average_score] %></div>
          <div class="text-sm text-gray-600">Avg per Forecast</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-gray-600"><%= @overall_stats[:forecast_count] %></div>
          <div class="text-sm text-gray-600">Total Forecasts</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 pt-6 border-t border-gray-200">
        <div class="text-center">
          <div class="text-lg font-semibold text-gray-900"><%= @overall_stats[:accuracy_score] %></div>
          <div class="text-sm text-gray-600">Accuracy Points</div>
        </div>
        <div class="text-center">
          <div class="text-lg font-semibold text-gray-900"><%= @overall_stats[:contrarian_bonus] %></div>
          <div class="text-sm text-gray-600">Contrarian Bonus</div>
        </div>
        <div class="text-center">
          <div class="text-lg font-semibold text-gray-900"><%= @overall_stats[:gameweeks_participated] %></div>
          <div class="text-sm text-gray-600">Weeks Participated</div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Performance Highlights -->
  <% if @weekly_performance.any? %>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <% if @best_week %>
        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
          <h3 class="font-semibold text-green-900 mb-2">Best Week</h3>
          <div class="text-2xl font-bold text-green-700">GW<%= @best_week[:week] %></div>
          <div class="text-lg text-green-600"><%= @best_week[:total_score] %> points</div>
        </div>
      <% end %>

      <% if @avg_weekly_score %>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
          <h3 class="font-semibold text-blue-900 mb-2">Weekly Average</h3>
          <div class="text-2xl font-bold text-blue-700"><%= @avg_weekly_score %></div>
          <div class="text-lg text-blue-600">points per week</div>
        </div>
      <% end %>

      <% if @recent_form %>
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
          <h3 class="font-semibold text-purple-900 mb-2">Recent Form</h3>
          <div class="text-2xl font-bold text-purple-700"><%= @recent_form %></div>
          <div class="text-lg text-purple-600">last 5 weeks</div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Forecast Creation (Own Profile Only) -->
  <% if @is_own_profile && @current_gameweek %>
    <div class="bg-white shadow-sm rounded-lg p-6 mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-900">Make Forecasts for Gameweek <%= @current_gameweek.fpl_id %></h2>
        <%= link_to "Full Forecast Interface", new_forecast_path,
            class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700" %>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Current Targets -->
        <div>
          <h3 class="text-lg font-medium text-gray-900 mb-3">My Targets (<%= (@current_forecasts["target"] || []).size %>)</h3>
          <% if (@current_forecasts["target"] || []).any? %>
            <div class="space-y-2">
              <% @current_forecasts["target"].each do |forecast| %>
                <div class="flex items-center justify-between bg-green-50 p-3 rounded-lg">
                  <div>
                    <span class="font-medium text-gray-900"><%= forecast.player.first_name %> <%= forecast.player.last_name %></span>
                    <span class="text-sm text-gray-600 ml-2">(<%= forecast.player.team.name %>)</span>
                  </div>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <%= forecast.player.position.upcase[0..2] %>
                  </span>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-gray-500 text-sm">No targets selected yet</p>
          <% end %>
        </div>

        <!-- Current Avoids -->
        <div>
          <h3 class="text-lg font-medium text-gray-900 mb-3">My Avoids (<%= (@current_forecasts["avoid"] || []).size %>)</h3>
          <% if (@current_forecasts["avoid"] || []).any? %>
            <div class="space-y-2">
              <% @current_forecasts["avoid"].each do |forecast| %>
                <div class="flex items-center justify-between bg-red-50 p-3 rounded-lg">
                  <div>
                    <span class="font-medium text-gray-900"><%= forecast.player.first_name %> <%= forecast.player.last_name %></span>
                    <span class="text-sm text-gray-600 ml-2">(<%= forecast.player.team.name %>)</span>
                  </div>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                    <%= forecast.player.position.upcase[0..2] %>
                  </span>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-gray-500 text-sm">No avoids selected yet</p>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Weekly Performance History -->
  <div class="bg-white shadow-sm rounded-lg overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">Weekly Performance History</h2>
    </div>

    <% if @weekly_performance.any? %>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Week</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Score</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Accuracy</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Contrarian</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Forecasts</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Score</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @weekly_performance.each_with_index do |week, index| %>
            <tr class="<%= index < 3 ? 'bg-gray-50' : 'hover:bg-gray-50' %>">
              <td class="px-6 py-4 whitespace-nowrap">
                <%= link_to weekly_forecasts_user_path(@user, week: week[:week]),
                    class: "text-sm font-medium text-blue-600 hover:text-blue-900" do %>
                  Gameweek <%= week[:week] %>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center">
                <span class="text-lg font-bold text-gray-900"><%= week[:total_score] %></span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center">
                <span class="text-sm text-gray-700"><%= week[:accuracy_score] %></span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center">
                <span class="text-sm text-gray-700"><%= week[:contrarian_bonus] %></span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center">
                <span class="text-sm text-gray-700"><%= week[:forecast_count] %></span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center">
                <span class="text-sm font-medium text-gray-900"><%= week[:average_score] %></span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="px-6 py-12 text-center">
        <p class="text-gray-500">No performance data available yet.</p>
        <p class="text-gray-400 text-sm mt-2">Weekly performance will appear once forecasts have been scored.</p>
      </div>
    <% end %>
  </div>
</div>